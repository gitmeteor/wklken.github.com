<!DOCTYPE html>
<html lang="en">

<!--[if IE 8]> <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->

<head>
    <meta name="google-site-verification" content="SzE6WCs23qFevgBzRIuG9vcfLU0lW_Vd5hFT-cJOLBE" />
    <title>[翻译]理解python中的装饰器</title>
    <meta charset="utf-8" />
    <meta name="description" content="">
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

        <link rel="shortcut icon" href="/favicon.ico"/>
        <link rel="stylesheet" href="/theme/css/styles.css" media="all" />
        <link rel="stylesheet" href="/theme/css/monokai.css" media="all" />
        <link rel="stylesheet" href="/theme/css/tab.min.css" media="all" />
        <link rel="stylesheet" href="/theme/css/jquery-ui.min.css" media="all" />

        <link rel="stylesheet" href="/theme/css/font-awesome.min.css">
        <!--
        <link rel="stylesheet" href="http://apps.bdimg.com/libs/fontawesome/4.2.0/css/font-awesome.min.css">
        -->
        <!--[if IE 7]>
            <link rel="stylesheet" href="/theme/css/font-awesome-ie7.min.css">
        <![endif]-->

        <link href="/" type="application/atom+xml" rel="alternate" title="wklken's blog ATOM Feed" />
        <link href="/feed.xml" type="application/atom+xml" rel="alternate" title="wklken's blog RSS Feed" />

</head>

<body>
    <div id="page" class="row">
        <div class="large-9 large-centered columns">

        <header id="header">
            <div class="constraint">
                <div class="o">
                    <a href="/"><h1 class="banner">Wklken <span class="blue"> Building </span></h1></a>

                <div class="social">
                            <a href="https://github.com/wklken" target='_blank'><i class="icon-github-sign icon-2x"></i></a>
                            <a href="http://weibo.com/wklken" target='_blank'><i class="icon-weibo icon-2x"></i></a>
                            <a href="mailto:wklken@yeah.net"><i class="icon-envelope icon-2x"></i></a>
                            <a href="http://www.wklken.me/feed.xml" target='_blank'><i class="icon-rss-sign icon-2x"></i></a>
                </div>
                <div class="nav">
                            <a href="/">首页</a>
                            <a href="/categories.html">分类</a>
                            <a href="/archives.html">归档</a>
                            <a href="/pages/projects.html">项目</a>
                            <a href="/pages/links.html">友链</a>
                            <a href="/pages/aboutme.html">关于</a>

                </div>

                </div>
            </div>
        </header><!-- /#banner -->

        <section id="main">


<article id="article">
    <section id="header">
        <!--
        <div class="meta">2013年07月19日</div>
        <h1 id="title"> [翻译]理解python中的装饰器 </h1>
        -->
        <div class="meta"> &nbsp; </div>
        <h1> [翻译]理解python中的装饰器 </h1>
    </section>

        <section id="toc">
            <div id="toc"><ul><li><a class="toc-href" href="#" title="[翻译]理解python中的装饰器">[翻译]理解python中的装饰器</a><ul><li><a class="toc-href" href="#pythonde-han-shu-shi-dui-xiang" title="python的函数是对象">python的函数是对象</a></li><li><a class="toc-href" href="#han-shu-yin-yong" title="函数引用">函数引用</a></li><li><a class="toc-href" href="#shou-gong-zhuang-shi-qi" title="手工装饰器">手工装饰器</a></li><li><a class="toc-href" href="#zhuang-shi-qi-chan-shu" title="装饰器阐述">装饰器阐述</a></li><li><a class="toc-href" href="#zui-hou-hui-da-wen-ti" title="最后回答问题">最后回答问题</a><ul><li><a class="toc-href" href="#xiang-zhuang-shi-qi-han-shu-chuan-di-can-shu" title="向装饰器函数传递参数">向装饰器函数传递参数</a></li><li><a class="toc-href" href="#zhuang-shi-fang-fa" title="装饰方法">装饰方法</a></li><li><a class="toc-href" href="#xiang-zhuang-shi-qi-chuan-di-can-shu" title="向装饰器传递参数">向装饰器传递参数</a></li><li><a class="toc-href" href="#lian-xi-yi-ge-zhuang-shi-zhuang-shi-qi-de-zhuang-shi-qi" title="练习：一个装饰装饰器的装饰器">练习：一个装饰装饰器的装饰器</a></li></ul></li><li><a class="toc-href" href="#zhuang-shi-qi-shi-yong-zui-jia-shi-jian_1" title="装饰器使用最佳实践">装饰器使用最佳实践</a><ul><li><a class="toc-href" href="#zhuang-shi-qi-wei-he-na-yao-you-yong" title="装饰器为何那么有用">装饰器为何那么有用</a></li></ul></li></ul></li></ul></div>
        </section>
    <section id="content">
        <p>有人翻译过了，很多转载，暂时没找到原文，各个地方的排版不一样，排版（代码格式），代码注解等都不怎么好</p>
<p>练练手，顺手一翻吧，权当加深理解</p>
<p>来源stackoverflow上的问题  <a href="http://stackoverflow.com/questions/739654/how-can-i-make-a-chain-of-function-decorators-in-python/1594484#1594484">链接</a></p>
<p>很长哦(应该是巨长...分了三次搞完)，要有耐心看完</p>
<hr/>
<h2 id="pythonde-han-shu-shi-dui-xiang">python的函数是对象</h2>
<p>要理解装饰器，首先，你必须明白，在python中，函数是对象. 这很重要.</p>
<p>简单例子来理解为什么</p>
<div class="monokai"><pre><span class="code-line"><span></span>def shout(word="yes"):</span>
<span class="code-line">    return word.capitalize()+"!"</span>
<span class="code-line"></span>
<span class="code-line">print shout()</span>
<span class="code-line"># outputs : 'Yes!'</span>
<span class="code-line"></span>
<span class="code-line"># 作为一个对象，你可以讲函数赋值给另一个对象</span>
<span class="code-line">scream = shout</span>
<span class="code-line"></span>
<span class="code-line"># 注意到这里我们并没有使用括号：我们不是调用函数，而是将函数'shout'赋给变量'scream'</span>
<span class="code-line"># 这意味着，你可以通过'scream'调用'shout'</span>
<span class="code-line"></span>
<span class="code-line">print scream()</span>
<span class="code-line"># outputs : 'Yes!'</span>
<span class="code-line"></span>
<span class="code-line"># 不仅如此，你可以删除老的名称'shout'，但是通过'scream'依旧可以访问原有函数</span>
<span class="code-line"></span>
<span class="code-line">del shout</span>
<span class="code-line">try:</span>
<span class="code-line">    print shout()</span>
<span class="code-line">except NameError, e:</span>
<span class="code-line">    print e</span>
<span class="code-line">    #outputs: "name 'shout' is not defined"</span>
<span class="code-line"></span>
<span class="code-line">print scream()</span>
<span class="code-line"># outputs: 'Yes!'</span>
</pre></div>
<p>好了，记住这点，我们将会很快用到它.</p>
<p>Python函数另一个有趣的特性是，函数可以被定义在另一个函数里面</p>
<div class="monokai"><pre><span class="code-line"><span></span>def talk():</span>
<span class="code-line">    # 你可以定义一个函数</span>
<span class="code-line">    def whisper(word="yes"):</span>
<span class="code-line">        return word.lower()+"..."</span>
<span class="code-line"></span>
<span class="code-line">    # ... 并且立刻调用</span>
<span class="code-line">    print whisper()</span>
<span class="code-line"></span>
<span class="code-line"># 每次当你调用"talk", 都会定义"whisper"</span>
<span class="code-line"># 并且在"talk"中被调用</span>
<span class="code-line">talk()</span>
<span class="code-line"># outputs:</span>
<span class="code-line"># "yes..."</span>
<span class="code-line"></span>
<span class="code-line">#但是在"talk"外部，函数"whisper"不存在！</span>
<span class="code-line">try:</span>
<span class="code-line">    print whisper()</span>
<span class="code-line">except NameError, e:</span>
<span class="code-line">    print e</span>
<span class="code-line">    #outputs : "name 'whisper' is not defined"*</span>
</pre></div>
<h2 id="han-shu-yin-yong">函数引用</h2>
<p>好了，到这里了，接下来是有意思的部分，我们刚才看到 函数是对象，然后:</p>
<p>1.函数可以赋值给一个变量</p>
<p>2.函数可以定义在另一个函数内部</p>
<p>即，这也意味着一个函数可以返回另一个函数:-）,让我们来看另一段代码</p>
<div class="monokai"><pre><span class="code-line"><span></span>def getTalk(type="shout"):</span>
<span class="code-line"></span>
<span class="code-line">    # 定义函数</span>
<span class="code-line">    def shout(word="yes"):</span>
<span class="code-line">        return word.capitalize()+"!"</span>
<span class="code-line"></span>
<span class="code-line">    def whisper(word="yes") :</span>
<span class="code-line">        return word.lower()+"...";</span>
<span class="code-line"></span>
<span class="code-line">    # 返回函数</span>
<span class="code-line">    if type == "shout":</span>
<span class="code-line">        # 没有使用"()", 并不是要调用函数，而是要返回函数对象</span>
<span class="code-line">        return shout</span>
<span class="code-line">    else:</span>
<span class="code-line">        return whisper</span>
<span class="code-line"></span>
<span class="code-line"># 如何使用？</span>
<span class="code-line"></span>
<span class="code-line"># 将函数返回值赋值给一个变量</span>
<span class="code-line">talk = getTalk()</span>
<span class="code-line"></span>
<span class="code-line"># 我们可以打印下这个函数对象</span>
<span class="code-line">print talk</span>
<span class="code-line">#outputs : &lt;function shout at 0xb7ea817c&gt;</span>
<span class="code-line"></span>
<span class="code-line"># 这个对象是函数的返回值</span>
<span class="code-line">print talk()</span>
<span class="code-line">#outputs : Yes!</span>
<span class="code-line"></span>
<span class="code-line"># 不仅如此，你还可以直接使用之</span>
<span class="code-line">print getTalk("whisper")()</span>
<span class="code-line">#outputs : yes...</span>
</pre></div>
<p>但是稍等，如果你可以返回一个函数，那么你也可以将函数作为参数传递</p>
<div class="monokai"><pre><span class="code-line"><span></span>def doSomethingBefore(func):</span>
<span class="code-line">    print "I do something before then I call the function you gave me"</span>
<span class="code-line">    print func()</span>
<span class="code-line"></span>
<span class="code-line">doSomethingBefore(scream)</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I do something before then I call the function you gave me</span>
<span class="code-line">#Yes!</span>
</pre></div>
<p>好了，现在你已经了解要理解装饰器的每件事.</p>
<p>装饰器就是封装器，可以让你在被装饰函数之前或之后执行代码，而不必修改函数本身</p>
<h2 id="shou-gong-zhuang-shi-qi">手工装饰器</h2>
<p>如何书写一个装饰器</p>
<div class="monokai"><pre><span class="code-line"><span></span># 装饰器是一个以另一个函数为参数的函数</span>
<span class="code-line">def my_shiny_new_decorator(a_function_to_decorate):</span>
<span class="code-line"></span>
<span class="code-line">    # 在这里，装饰器定义一个函数： 包装器.</span>
<span class="code-line">    # 这个函数将原始函数进行包装，以达到在原始函数之前、之后执行代码的目的</span>
<span class="code-line">    def the_wrapper_around_the_original_function():</span>
<span class="code-line"></span>
<span class="code-line">        # 将你要在原始函数之前执行的代码放到这里</span>
<span class="code-line">        print "Before the function runs"</span>
<span class="code-line"></span>
<span class="code-line">        # 调用原始函数(需要带括号)</span>
<span class="code-line">        a_function_to_decorate()</span>
<span class="code-line"></span>
<span class="code-line">        # 将你要在原始函数之后执行的代码放到这里</span>
<span class="code-line">        print "After the function runs"</span>
<span class="code-line"></span>
<span class="code-line">    # 代码到这里，函数‘a_function_to_decorate’还没有被执行</span>
<span class="code-line">    # 我们将返回刚才创建的这个包装函数</span>
<span class="code-line">    # 这个函数包含原始函数及要执行的附加代码，并且可以被使用</span>
<span class="code-line">    return the_wrapper_around_the_original_function</span>
<span class="code-line"></span>
<span class="code-line"># 创建一个函数</span>
<span class="code-line">def a_stand_alone_function():</span>
<span class="code-line">    print "I am a stand alone function, don't you dare modify me"</span>
<span class="code-line"></span>
<span class="code-line">a_stand_alone_function()</span>
<span class="code-line">#outputs: I am a stand alone function, don't you dare modify me</span>
<span class="code-line"></span>
<span class="code-line"># 好了，在这里你可以装饰这个函数，扩展其行为</span>
<span class="code-line"># 将函数传递给装饰器，装饰器将动态地将其包装在任何你想执行的代码中，然后返回一个新的函数</span>
<span class="code-line">a_stand_alone_function_decorated = my_shiny_new_decorator(a_stand_alone_function)</span>
<span class="code-line"></span>
<span class="code-line"># 调用新函数，可以看到装饰器的效果</span>
<span class="code-line">a_stand_alone_function_decorated()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#Before the function runs</span>
<span class="code-line">#I am a stand alone function, don't you dare modify me</span>
<span class="code-line">#After the function runs</span>
</pre></div>
<p>到这里，或许你想每次调用a_stand_alone_function都使用a_stand_alone_function_decorated替代之
很简单，只需要将a_stand_alone_function用my_shiny_new_decorator装饰返回</p>
<div class="monokai"><pre><span class="code-line"><span></span>a_stand_alone_function = my_shiny_new_decorator(a_stand_alone_function)</span>
<span class="code-line">a_stand_alone_function()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#Before the function runs</span>
<span class="code-line">#I am a stand alone function, don't you dare modify me</span>
<span class="code-line">#After the function runs</span>
<span class="code-line"></span>
<span class="code-line"># 这就是装饰器做的事情!</span>
</pre></div>
<h2 id="zhuang-shi-qi-chan-shu">装饰器阐述</h2>
<p>前面的例子，使用装饰器语法</p>
<div class="monokai"><pre><span class="code-line"><span></span>@my_shiny_new_decorator</span>
<span class="code-line">def another_stand_alone_function():</span>
<span class="code-line">    print "Leave me alone"</span>
<span class="code-line"></span>
<span class="code-line">another_stand_alone_function()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#Before the function runs</span>
<span class="code-line">#Leave me alone</span>
<span class="code-line">#After the function runs</span>
</pre></div>
<p>是的，就是这么简单. @decorator是下面代码的简写</p>
<div class="monokai"><pre><span class="code-line"><span></span>nother_stand_alone_function = my_shiny_new_decorator(another_stand_alone_function)</span>
</pre></div>
<p>装饰器只是 <a href="http://en.wikipedia.org/wiki/Decorator_pattern">装饰器模式</a>的python实现</p>
<p>python代码中还存在其他几个经典的设计模式，以方便开发，例如迭代器iterators</p>
<p>当然，你可以累加装饰器</p>
<div class="monokai"><pre><span class="code-line"><span></span>def bread(func):</span>
<span class="code-line">    def wrapper():</span>
<span class="code-line">        print "<span class="err">&lt;</span>/''''''\&gt;"</span>
<span class="code-line">        func()</span>
<span class="code-line">        print "<span class="err">&lt;</span>\______/&gt;"</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line">def ingredients(func):</span>
<span class="code-line">    def wrapper():</span>
<span class="code-line">        print "#tomatoes#"</span>
<span class="code-line">        func()</span>
<span class="code-line">        print "~salad~"</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line">def sandwich(food="--ham--"):</span>
<span class="code-line">    print food</span>
<span class="code-line"></span>
<span class="code-line">sandwich()</span>
<span class="code-line">#outputs: --ham--</span>
<span class="code-line"></span>
<span class="code-line">#累加两个装饰器</span>
<span class="code-line">sandwich = bread(ingredients(sandwich))</span>
<span class="code-line">sandwich()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#<span class="err">&lt;</span>/''''''\&gt;</span>
<span class="code-line"># #tomatoes#</span>
<span class="code-line"># --ham--</span>
<span class="code-line"># ~salad~</span>
<span class="code-line">#<span class="err">&lt;</span>\______/&gt;</span>
</pre></div>
<p>使用python装饰器语法</p>
<div class="monokai"><pre><span class="code-line"><span></span>@bread</span>
<span class="code-line">@ingredients</span>
<span class="code-line">def sandwich(food="--ham--"):</span>
<span class="code-line">    print food</span>
<span class="code-line"></span>
<span class="code-line">sandwich()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#&lt;/''''''\&gt;</span>
<span class="code-line"># #tomatoes#</span>
<span class="code-line"># --ham--</span>
<span class="code-line"># ~salad~</span>
<span class="code-line">#&lt;\______/&gt;</span>
</pre></div>
<p>装饰器位置的顺序很重要</p>
<div class="monokai"><pre><span class="code-line"><span></span>@ingredients</span>
<span class="code-line">@bread</span>
<span class="code-line">def strange_sandwich(food="--ham--"):</span>
<span class="code-line">    print food</span>
<span class="code-line"></span>
<span class="code-line">    strange_sandwich()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">##tomatoes#</span>
<span class="code-line">#&lt;/''''\&gt;</span>
<span class="code-line"># --ham--</span>
<span class="code-line">#&lt;\______/&gt;</span>
<span class="code-line"># ~salad~'</span>
</pre></div>
<h2 id="zui-hou-hui-da-wen-ti">最后回答问题</h2>
<div class="monokai"><pre><span class="code-line"><span></span># bold装饰器</span>
<span class="code-line">def makebold(fn):</span>
<span class="code-line">    def wrapper():</span>
<span class="code-line">        # 在前后加入标签</span>
<span class="code-line">        return "<span class="nt">&lt;b&gt;</span>" + fn() + "<span class="nt">&lt;/b&gt;</span>"</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line"># italic装饰器</span>
<span class="code-line">def makeitalic(fn):</span>
<span class="code-line">    def wrapper():</span>
<span class="code-line">        # 加入标签</span>
<span class="code-line">        return "<span class="nt">&lt;i&gt;</span>" + fn() + "<span class="nt">&lt;/i&gt;</span>"</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line">@makebold</span>
<span class="code-line">@makeitalic</span>
<span class="code-line">def say():</span>
<span class="code-line">    return "hello"</span>
<span class="code-line"></span>
<span class="code-line">print say()</span>
<span class="code-line">#outputs: <span class="nt">&lt;b&gt;&lt;i&gt;</span>hello<span class="nt">&lt;/i&gt;&lt;/b&gt;</span></span>
<span class="code-line"></span>
<span class="code-line"># 等价的代码</span>
<span class="code-line">def say():</span>
<span class="code-line">    return "hello"</span>
<span class="code-line">say = makebold(makeitalic(say))</span>
<span class="code-line"></span>
<span class="code-line">print say()</span>
<span class="code-line">#outputs: <span class="nt">&lt;b&gt;&lt;i&gt;</span>hello<span class="nt">&lt;/i&gt;&lt;/b&gt;</span></span>
</pre></div>
<p>好了，到这里你可以高兴地离开了，或者来看下一些装饰器高级的用法</p>
<h3 id="xiang-zhuang-shi-qi-han-shu-chuan-di-can-shu">向装饰器函数传递参数</h3>
<div class="monokai"><pre><span class="code-line"><span></span># 这不是黑魔法，你只需要让包装传递参数:</span>
<span class="code-line"></span>
<span class="code-line">def a_decorator_passing_arguments(function_to_decorate):</span>
<span class="code-line">    def a_wrapper_accepting_arguments(arg1, arg2):</span>
<span class="code-line">            print "I got args! Look:", arg1, arg2</span>
<span class="code-line">            function_to_decorate(arg1, arg2)</span>
<span class="code-line">    return a_wrapper_accepting_arguments</span>
<span class="code-line"></span>
<span class="code-line"># 当你调用装饰器返回的函数，实际上是调用包装函数，所以给包装函数传递参数即可将参数传给装饰器函数</span>
<span class="code-line"></span>
<span class="code-line">@a_decorator_passing_arguments</span>
<span class="code-line">def print_full_name(first_name, last_name):</span>
<span class="code-line">    print "My name is", first_name, last_name</span>
<span class="code-line"></span>
<span class="code-line">print_full_name("Peter", "Venkman")</span>
<span class="code-line"># outputs:</span>
<span class="code-line">#I got args! Look: Peter Venkman</span>
<span class="code-line">#My name is Peter Venkman</span>
</pre></div>
<h3 id="zhuang-shi-fang-fa">装饰方法</h3>
<p>Python中对象的方法和函数是一样的，除了对象的方法首个参数是指向当前对象的引用(self)。这意味着你可以用同样的方法构建一个装饰器，只是必须考虑self</p>
<div class="monokai"><pre><span class="code-line"><span></span><span class="s s-Atom">def</span> <span class="nf">method_friendly_decorator</span><span class="p">(</span><span class="s s-Atom">method_to_decorate</span><span class="p">)</span><span class="s s-Atom">:</span></span>
<span class="code-line">    <span class="s s-Atom">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">lie</span><span class="p">)</span><span class="s s-Atom">:</span></span>
<span class="code-line">        <span class="s s-Atom">lie</span> <span class="o">=</span> <span class="s s-Atom">lie</span> <span class="o">-</span> <span class="mi">3</span> <span class="s s-Atom">#</span> <span class="s s-Atom">very</span> <span class="s s-Atom">friendly</span><span class="p">,</span> <span class="s s-Atom">decrease</span> <span class="s s-Atom">age</span> <span class="s s-Atom">even</span> <span class="nf">more</span> <span class="o">:-</span><span class="p">)</span></span>
<span class="code-line">        <span class="s s-Atom">return</span> <span class="nf">method_to_decorate</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">lie</span><span class="p">)</span></span>
<span class="code-line">    <span class="s s-Atom">return</span> <span class="s s-Atom">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="s s-Atom">class</span> <span class="nv">Lucy</span><span class="p">(</span><span class="s s-Atom">object</span><span class="p">)</span><span class="s s-Atom">:</span></span>
<span class="code-line"></span>
<span class="code-line">    <span class="s s-Atom">def</span> <span class="k">__</span><span class="nf">init__</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">)</span><span class="s s-Atom">:</span></span>
<span class="code-line">        <span class="s s-Atom">self</span><span class="p">.</span><span class="s s-Atom">age</span> <span class="o">=</span> <span class="mi">32</span></span>
<span class="code-line"></span>
<span class="code-line">    <span class="s s-Atom">@method_friendly_decorator</span></span>
<span class="code-line">    <span class="s s-Atom">def</span> <span class="nf">sayYourAge</span><span class="p">(</span><span class="s s-Atom">self</span><span class="p">,</span> <span class="s s-Atom">lie</span><span class="p">)</span><span class="s s-Atom">:</span></span>
<span class="code-line">        <span class="s s-Atom">print</span> <span class="s2">"I am %s, what did you think?"</span> <span class="c1">% (self.age + lie)</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="s s-Atom">l</span> <span class="o">=</span> <span class="nv">Lucy</span><span class="p">()</span></span>
<span class="code-line"><span class="s s-Atom">l</span><span class="p">.</span><span class="nf">sayYourAge</span><span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span></span>
<span class="code-line"><span class="c1">#outputs: I am 26, what did you think?</span></span>
</pre></div>
<p>当然，你可以构造一个更加通用的装饰器，可以作用在任何函数或对象方法上，而不必关系其参数
使用</p>
<div class="monokai"><pre><span class="code-line"><span></span>*args, **kwargs</span>
</pre></div>
<p>如下代码</p>
<div class="monokai"><pre><span class="code-line"><span></span>def a_decorator_passing_arbitrary_arguments(function_to_decorate):</span>
<span class="code-line">    # 包装函数可以接受任何参数</span>
<span class="code-line">    def a_wrapper_accepting_arbitrary_arguments(*args, **kwargs):</span>
<span class="code-line">        print "Do I have args?:"</span>
<span class="code-line">        print args</span>
<span class="code-line">        print kwargs</span>
<span class="code-line">        # 然后你可以解开参数， *args，**kwargs</span>
<span class="code-line">        # 如果你对此不是很熟悉，可以参考 http://www.saltycrane.com/blog/2008/01/how-to-use-args-and-kwargs-in-python/</span>
<span class="code-line">        function_to_decorate(*args, **kwargs)</span>
<span class="code-line">    return a_wrapper_accepting_arbitrary_arguments</span>
<span class="code-line"></span>
<span class="code-line">@a_decorator_passing_arbitrary_arguments</span>
<span class="code-line">def function_with_no_argument():</span>
<span class="code-line">    print "Python is cool, no argument here."</span>
<span class="code-line"></span>
<span class="code-line">function_with_no_argument()</span>
<span class="code-line">#outputs</span>
<span class="code-line">#Do I have args?:</span>
<span class="code-line">#()</span>
<span class="code-line">#{}</span>
<span class="code-line">#Python is cool, no argument here.</span>
<span class="code-line"></span>
<span class="code-line">@a_decorator_passing_arbitrary_arguments</span>
<span class="code-line">def function_with_arguments(a, b, c):</span>
<span class="code-line">    print a, b, c</span>
<span class="code-line"></span>
<span class="code-line">function_with_arguments(1,2,3)</span>
<span class="code-line">#outputs</span>
<span class="code-line">#Do I have args?:</span>
<span class="code-line">#(1, 2, 3)</span>
<span class="code-line">#{}</span>
<span class="code-line">#1 2 3</span>
<span class="code-line"></span>
<span class="code-line">@a_decorator_passing_arbitrary_arguments</span>
<span class="code-line">def function_with_named_arguments(a, b, c, platypus="Why not ?"):</span>
<span class="code-line">    print "Do %s, %s and %s like platypus? %s" %\</span>
<span class="code-line">    (a, b, c, platypus)</span>
<span class="code-line"></span>
<span class="code-line">function_with_named_arguments("Bill", "Linus", "Steve", platypus="Indeed!")</span>
<span class="code-line">#outputs</span>
<span class="code-line">#Do I have args ? :</span>
<span class="code-line">#('Bill', 'Linus', 'Steve')</span>
<span class="code-line">#{'platypus': 'Indeed!'}</span>
<span class="code-line">#Do Bill, Linus and Steve like platypus? Indeed!</span>
<span class="code-line"></span>
<span class="code-line">class Mary(object):</span>
<span class="code-line">    def __init__(self):</span>
<span class="code-line">        self.age = 31</span>
<span class="code-line"></span>
<span class="code-line">    @a_decorator_passing_arbitrary_arguments</span>
<span class="code-line">    def sayYourAge(self, lie=-3): # You can now add a default value</span>
<span class="code-line">        print "I am %s, what did you think ?" % (self.age + lie)</span>
<span class="code-line"></span>
<span class="code-line">m = Mary()</span>
<span class="code-line">m.sayYourAge()</span>
<span class="code-line">#outputs</span>
<span class="code-line"># Do I have args?:</span>
<span class="code-line">#(&lt;__main__.Mary object at 0xb7d303ac&gt;,)</span>
<span class="code-line">#{}</span>
<span class="code-line">#I am 28, what did you think?</span>
</pre></div>
<h3 id="xiang-zhuang-shi-qi-chuan-di-can-shu">向装饰器传递参数</h3>
<p>好了，现在你或许会想是否可以向装饰器本身传递参数</p>
<p>装饰器必须使用函数作为参数，所以这看起来会有些复杂，你不能直接传递参数给装饰器本身</p>
<p>在开始处理这个问题前，看一点提醒</p>
<div class="monokai"><pre><span class="code-line"><span></span># 装饰器是普通的方法</span>
<span class="code-line">def my_decorator(func):</span>
<span class="code-line">    print "I am a ordinary function"</span>
<span class="code-line">    def wrapper():</span>
<span class="code-line">        print "I am function returned by the decorator"</span>
<span class="code-line">        func()</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line"># 所以，你可以不通过@调用它</span>
<span class="code-line"></span>
<span class="code-line">def lazy_function():</span>
<span class="code-line">    print "zzzzzzzz"</span>
<span class="code-line"></span>
<span class="code-line">decorated_function = my_decorator(lazy_function)</span>
<span class="code-line">#outputs: I am a ordinary function</span>
<span class="code-line"></span>
<span class="code-line"># It outputs "I am a ordinary function", because that's just what you do:</span>
<span class="code-line"></span>
<span class="code-line"># 调用一个函数，没有什么特别</span>
<span class="code-line">@my_decorator</span>
<span class="code-line">def lazy_function():</span>
<span class="code-line">    print "zzzzzzzz"</span>
<span class="code-line"></span>
<span class="code-line">#outputs: I am a ordinary function</span>
</pre></div>
<p>上面两个形式本质上是相同的， "my_decorator" 被调用.所以当你使用"@my_decorator",告诉python一个函数被变量"my_decorator"标记
这十分重要,因为你提供的标签直接指向装饰器...或者不是，继续</p>
<div class="monokai"><pre><span class="code-line"><span></span># 声明一个用于创建装饰器的函数</span>
<span class="code-line">def decorator_maker():</span>
<span class="code-line"></span>
<span class="code-line">    print "I make decorators! I am executed only once: "+\</span>
<span class="code-line">          "when you make me create a decorator."</span>
<span class="code-line"></span>
<span class="code-line">    def my_decorator(func):</span>
<span class="code-line">        print "I am a decorator! I am executed only when you decorate a function."</span>
<span class="code-line"></span>
<span class="code-line">        def wrapped():</span>
<span class="code-line">            print ("I am the wrapper around the decorated function. "</span>
<span class="code-line">                  "I am called when you call the decorated function. "</span>
<span class="code-line">                  "As the wrapper, I return the RESULT of the decorated function.")</span>
<span class="code-line">            return func()</span>
<span class="code-line"></span>
<span class="code-line">        print "As the decorator, I return the wrapped function."</span>
<span class="code-line">        return wrapped</span>
<span class="code-line"></span>
<span class="code-line">    print "As a decorator maker, I return a decorator"</span>
<span class="code-line">    return my_decorator</span>
<span class="code-line"></span>
<span class="code-line"># Let's create a decorator. It's just a new function after all.</span>
<span class="code-line"># 创建一个装饰器，本质上只是一个函数</span>
<span class="code-line">new_decorator = decorator_maker()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="code-line">#As a decorator maker, I return a decorator</span>
<span class="code-line"></span>
<span class="code-line"># 使用装饰器装饰函数</span>
<span class="code-line"></span>
<span class="code-line">def decorated_function():</span>
<span class="code-line">    print "I am the decorated function."</span>
<span class="code-line"></span>
<span class="code-line">decorated_function = new_decorator(decorated_function)</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="code-line">#As the decorator, I return the wrapped function</span>
<span class="code-line"></span>
<span class="code-line"># 调用被装饰函数</span>
<span class="code-line">decorated_function()</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="code-line">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="code-line">#I am the decorated function.</span>
</pre></div>
<p>我们跳过中间变量，做同样的事情</p>
<div class="monokai"><pre><span class="code-line"><span></span>def decorated_function():</span>
<span class="code-line">    print "I am the decorated function."</span>
<span class="code-line">decorated_function = decorator_maker()(decorated_function)</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="code-line">#As a decorator maker, I return a decorator</span>
<span class="code-line">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="code-line">#As the decorator, I return the wrapped function.</span>
<span class="code-line"></span>
<span class="code-line"># 最后:</span>
<span class="code-line">decorated_function()    </span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="code-line">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="code-line">#I am the decorated function.</span>
</pre></div>
<p>使用装饰器语法，更简短</p>
<div class="monokai"><pre><span class="code-line"><span></span>@decorator_maker()</span>
<span class="code-line">def decorated_function():</span>
<span class="code-line">    print "I am the decorated function."</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I make decorators! I am executed only once: when you make me create a decorator.</span>
<span class="code-line">#As a decorator maker, I return a decorator</span>
<span class="code-line">#I am a decorator! I am executed only when you decorate a function.</span>
<span class="code-line">#As the decorator, I return the wrapped function.</span>
<span class="code-line"></span>
<span class="code-line">#最终: </span>
<span class="code-line">decorated_function()    </span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I am the wrapper around the decorated function. I am called when you call the decorated function.</span>
<span class="code-line">#As the wrapper, I return the RESULT of the decorated function.</span>
<span class="code-line">#I am the decorated function.</span>
</pre></div>
<p>到这里，我们使用@调用一个函数</p>
<p>回到问题，向装饰器本身传递参数，如果我们可以通过函数去创建装饰器，那么我们可以传递参数给这个函数，对么？</p>
<div class="monokai"><pre><span class="code-line"><span></span>def decorator_maker_with_arguments(decorator_arg1, decorator_arg2):</span>
<span class="code-line"></span>
<span class="code-line">    print "I make decorators! And I accept arguments:", decorator_arg1, decorator_arg2</span>
<span class="code-line"></span>
<span class="code-line">    def my_decorator(func):</span>
<span class="code-line">        # 这里能传递参数的能力，是闭包的特性</span>
<span class="code-line">        # 更多闭包的内容，参考 http://stackoverflow.com/questions/13857/can-you-explain-closures-as-they-relate-to-python</span>
<span class="code-line">        print "I am the decorator. Somehow you passed me arguments:", decorator_arg1, decorator_arg2</span>
<span class="code-line"></span>
<span class="code-line">        # 不要搞混了装饰器参数和函数参数</span>
<span class="code-line">        def wrapped(function_arg1, function_arg2) :</span>
<span class="code-line">            print ("I am the wrapper around the decorated function.\n"</span>
<span class="code-line">                  "I can access all the variables\n"</span>
<span class="code-line">                  "\t- from the decorator: {0} {1}\n"</span>
<span class="code-line">                  "\t- from the function call: {2} {3}\n"</span>
<span class="code-line">                  "Then I can pass them to the decorated function"</span>
<span class="code-line">                  .format(decorator_arg1, decorator_arg2,</span>
<span class="code-line">                          function_arg1, function_arg2))</span>
<span class="code-line">            return func(function_arg1, function_arg2)</span>
<span class="code-line"></span>
<span class="code-line">        return wrapped</span>
<span class="code-line"></span>
<span class="code-line">    return my_decorator</span>
<span class="code-line"></span>
<span class="code-line">@decorator_maker_with_arguments("Leonard", "Sheldon")</span>
<span class="code-line">def decorated_function_with_arguments(function_arg1, function_arg2):</span>
<span class="code-line">    print ("I am the decorated function and only knows about my arguments: {0}"</span>
<span class="code-line">           " {1}".format(function_arg1, function_arg2))</span>
<span class="code-line"></span>
<span class="code-line">decorated_function_with_arguments("Rajesh", "Howard")</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I make decorators! And I accept arguments: Leonard Sheldon</span>
<span class="code-line">#I am the decorator. Somehow you passed me arguments: Leonard Sheldon</span>
<span class="code-line">#I am the wrapper around the decorated function. </span>
<span class="code-line">#I can access all the variables </span>
<span class="code-line">#   - from the decorator: Leonard Sheldon </span>
<span class="code-line">#   - from the function call: Rajesh Howard </span>
<span class="code-line">#Then I can pass them to the decorated function</span>
<span class="code-line">#I am the decorated function and only knows about my arguments: Rajesh Howard</span>
</pre></div>
<p>好了，that's it.参数可以设置为变量</p>
<div class="monokai"><pre><span class="code-line"><span></span>c1 = "Penny"</span>
<span class="code-line">c2 = "Leslie"</span>
<span class="code-line"></span>
<span class="code-line">@decorator_maker_with_arguments("Leonard", c1)</span>
<span class="code-line">def decorated_function_with_arguments(function_arg1, function_arg2):</span>
<span class="code-line">    print ("I am the decorated function and only knows about my arguments:"</span>
<span class="code-line">           " {0} {1}".format(function_arg1, function_arg2))</span>
<span class="code-line"></span>
<span class="code-line">decorated_function_with_arguments(c2, "Howard")</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#I make decorators! And I accept arguments: Leonard Penny</span>
<span class="code-line">#I am the decorator. Somehow you passed me arguments: Leonard Penny</span>
<span class="code-line">#I am the wrapper around the decorated function. </span>
<span class="code-line">#I can access all the variables </span>
<span class="code-line">#   - from the decorator: Leonard Penny </span>
<span class="code-line">#   - from the function call: Leslie Howard </span>
<span class="code-line">#Then I can pass them to the decorated function</span>
<span class="code-line">#I am the decorated function and only knows about my arguments: Leslie Howard</span>
</pre></div>
<p>你可以看到，你可以使用像其它函数一样使用这个方法向装饰器传递参数.如果你愿意你甚至可以使用 <em>arg </em>*kwargs.</p>
<p>但是记住，装饰器仅在Python代码导入时被调用一次,之后你不能动态地改变参数.当你使用"import x",函数已经被装饰，所以你不能改变什么</p>
<h3 id="lian-xi-yi-ge-zhuang-shi-zhuang-shi-qi-de-zhuang-shi-qi">练习：一个装饰装饰器的装饰器</h3>
<p>作为奖励，我将展示创建可以处理任何参数的装饰器代码片段. 毕竟，为了接收参数，必须使用另一个函数来创建装饰器</p>
<p>让我们来给装饰器写一个装饰器:</p>
<div class="monokai"><pre><span class="code-line"><span></span># 装饰 装饰器 的装饰器 (好绕.....)</span>
<span class="code-line">def decorator_with_args(decorator_to_enhance):</span>
<span class="code-line">    """ </span>
<span class="code-line">    这个函数将作为装饰器使用</span>
<span class="code-line">    它必须装饰另一个函数</span>
<span class="code-line">    它将允许任何接收任意数量参数的装饰器</span>
<span class="code-line">    方便你每次查询如何实现</span>
<span class="code-line">    """</span>
<span class="code-line"></span>
<span class="code-line">    # 同样的技巧传递参数</span>
<span class="code-line">    def decorator_maker(*args, **kwargs):</span>
<span class="code-line"></span>
<span class="code-line">        # 创建一个只接收函数的装饰器</span>
<span class="code-line">        # 但是这里保存了从创建者传递过来的的参数</span>
<span class="code-line">        def decorator_wrapper(func):</span>
<span class="code-line"></span>
<span class="code-line">            # 我们返回原始装饰器的结果</span>
<span class="code-line">            # 这是一个普通的函数，返回值是另一个函数</span>
<span class="code-line">            # 陷阱：装饰器必须有这个特殊的签名，否则不会生效</span>
<span class="code-line">            return decorator_to_enhance(func, *args, **kwargs)</span>
<span class="code-line"></span>
<span class="code-line">        return decorator_wrapper</span>
<span class="code-line"></span>
<span class="code-line">    return decorator_maker</span>
</pre></div>
<p>使用：</p>
<div class="monokai"><pre><span class="code-line"><span></span># 你创建这个函数是作为一个装饰器，但是给它附加了一个装饰器</span>
<span class="code-line"># 别忘了，函数签名是： "decorator(func, *args, **kwargs)"</span>
<span class="code-line">@decorator_with_args </span>
<span class="code-line">def decorated_decorator(func, *args, **kwargs): </span>
<span class="code-line">    def wrapper(function_arg1, function_arg2):</span>
<span class="code-line">        print "Decorated with", args, kwargs</span>
<span class="code-line">        return func(function_arg1, function_arg2)</span>
<span class="code-line">    return wrapper</span>
<span class="code-line"></span>
<span class="code-line"># 然后，使用这个装饰器(your brand new decorated decorator)</span>
<span class="code-line"></span>
<span class="code-line">@decorated_decorator(42, 404, 1024)</span>
<span class="code-line">def decorated_function(function_arg1, function_arg2):</span>
<span class="code-line">    print "Hello", function_arg1, function_arg2</span>
<span class="code-line"></span>
<span class="code-line">decorated_function("Universe and", "everything")</span>
<span class="code-line">#outputs:</span>
<span class="code-line">#Decorated with (42, 404, 1024) {}</span>
<span class="code-line">#Hello Universe and everything</span>
<span class="code-line"></span>
<span class="code-line"># Whoooot!</span>
</pre></div>
<p>我知道，到现在你一定会有这种感觉，就像你听一个人说“在理解递归之前，你必须首先了解递归”，但是现在，掌握这儿你有没有觉得很棒？</p>
<h2 id="zhuang-shi-qi-shi-yong-zui-jia-shi-jian_1">装饰器使用最佳实践</h2>
<ul>
<li>这是Python2.4的新特性，所以确保你的代码在2.4及之上的版本运行</li>
<li>装饰器降低了函数调用的性能，记住这点</li>
<li>You can not un-decorate a function. There are hacks to create decorators that can be removed but nobody uses them. So once a function is decorated, it's done. For all the code.</li>
<li>装饰器包装函数，所以很难debug</li>
</ul>
<p>Python2.5解决了最后一个问题，它提供functools模块，包含functools.wraps.这个函数会将被装饰函数的名称，模块，文档字符串拷贝给封装函数,有趣的是，functools.wraps是一个装饰器:-)</p>
<div class="monokai"><pre><span class="code-line"><span></span><span class="c1"># 调试，打印函数的名字</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span></span>
<span class="code-line">    <span class="k">print</span> <span class="s2">"foo"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">print</span> <span class="n">foo</span><span class="o">.</span><span class="n">__name__</span></span>
<span class="code-line"><span class="c1">#outputs: foo</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1"># 但当你使用装饰器，这一切变得混乱</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">func</span><span class="p">):</span></span>
<span class="code-line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span></span>
<span class="code-line">        <span class="k">print</span> <span class="s2">"bar"</span></span>
<span class="code-line">        <span class="k">return</span> <span class="n">func</span><span class="p">()</span></span>
<span class="code-line">    <span class="k">return</span> <span class="n">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="nd">@bar</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span></span>
<span class="code-line">    <span class="k">print</span> <span class="s2">"foo"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">print</span> <span class="n">foo</span><span class="o">.</span><span class="n">__name__</span></span>
<span class="code-line"><span class="c1">#outputs: wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1"># "functools" 可以改变这点</span></span>
<span class="code-line"><span class="kn">import</span> <span class="nn">functools</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">def</span> <span class="nf">bar</span><span class="p">(</span><span class="n">func</span><span class="p">):</span></span>
<span class="code-line">    <span class="c1"># 我们所说的 "wrapper", 封装 "func"</span></span>
<span class="code-line">    <span class="nd">@functools.wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span></span>
<span class="code-line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">():</span></span>
<span class="code-line">        <span class="k">print</span> <span class="s2">"bar"</span></span>
<span class="code-line">        <span class="k">return</span> <span class="n">func</span><span class="p">()</span></span>
<span class="code-line">    <span class="k">return</span> <span class="n">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="nd">@bar</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">foo</span><span class="p">():</span></span>
<span class="code-line">    <span class="k">print</span> <span class="s2">"foo"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1"># 得到的是原始的名称, 而不是封装器的名称</span></span>
<span class="code-line"><span class="k">print</span> <span class="n">foo</span><span class="o">.</span><span class="n">__name__</span></span>
<span class="code-line"><span class="c1">#outputs: foo</span></span>
</pre></div>
<h3 id="zhuang-shi-qi-wei-he-na-yao-you-yong">装饰器为何那么有用</h3>
<p>现在的问题是，我们用装饰器来坐什么？看起来很酷很强大，但是如果有实践的例子会更好.好了，有1000种可能。经典的用法是，在函数的外部，扩展一个函数的行为（你不需要改变这个函数），或者，为了调试的目的（我们不修改的原因是这是临时的），你可以使用装饰器扩展一些函数,而不用在这些函数中书写相同的函数实现一样的功能</p>
<p>DRY原则，例子：</p>
<div class="monokai"><pre><span class="code-line"><span></span><span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">func</span><span class="p">):</span></span>
<span class="code-line">    <span class="sd">"""</span></span>
<span class="code-line"><span class="sd">    装饰器打印一个函数的执行时间</span></span>
<span class="code-line"><span class="sd">    """</span></span>
<span class="code-line">    <span class="kn">import</span> <span class="nn">time</span></span>
<span class="code-line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></span>
<span class="code-line">        <span class="n">t</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span></span>
<span class="code-line">        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></span>
<span class="code-line">        <span class="k">print</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">clock</span><span class="p">()</span><span class="o">-</span><span class="n">t</span></span>
<span class="code-line">        <span class="k">return</span> <span class="n">res</span></span>
<span class="code-line">    <span class="k">return</span> <span class="n">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">def</span> <span class="nf">logging</span><span class="p">(</span><span class="n">func</span><span class="p">):</span></span>
<span class="code-line">    <span class="sd">"""</span></span>
<span class="code-line"><span class="sd">    装饰器记录函数日志</span></span>
<span class="code-line"><span class="sd">    """</span></span>
<span class="code-line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></span>
<span class="code-line">        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></span>
<span class="code-line">        <span class="k">print</span> <span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span></span>
<span class="code-line">        <span class="k">return</span> <span class="n">res</span></span>
<span class="code-line">    <span class="k">return</span> <span class="n">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">def</span> <span class="nf">counter</span><span class="p">(</span><span class="n">func</span><span class="p">):</span></span>
<span class="code-line">    <span class="sd">"""</span></span>
<span class="code-line"><span class="sd">    记录并打印一个函数的执行次数</span></span>
<span class="code-line"><span class="sd">    """</span></span>
<span class="code-line">    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span></span>
<span class="code-line">        <span class="n">wrapper</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span></span>
<span class="code-line">        <span class="n">res</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></span>
<span class="code-line">        <span class="k">print</span> <span class="s2">"{0} has been used: {1}x"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">wrapper</span><span class="o">.</span><span class="n">count</span><span class="p">)</span></span>
<span class="code-line">        <span class="k">return</span> <span class="n">res</span></span>
<span class="code-line">    <span class="n">wrapper</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span></span>
<span class="code-line">    <span class="k">return</span> <span class="n">wrapper</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="nd">@counter</span></span>
<span class="code-line"><span class="nd">@benchmark</span></span>
<span class="code-line"><span class="nd">@logging</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">reverse_string</span><span class="p">(</span><span class="n">string</span><span class="p">):</span></span>
<span class="code-line">    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">string</span><span class="p">))</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">print</span> <span class="n">reverse_string</span><span class="p">(</span><span class="s2">"Able was I ere I saw Elba"</span><span class="p">)</span></span>
<span class="code-line"><span class="k">print</span> <span class="n">reverse_string</span><span class="p">(</span><span class="s2">"A man, a plan, a canoe, pasta, heros, rajahs, a coloratura, maps, snipe, percale, macaroni, a gag, a banana bag, a tan, a tag, a banana bag again (or a camel), a crepe, pins, Spam, a rut, a Rolo, cash, a jar, sore hats, a peon, a canal: Panama!"</span><span class="p">)</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1">#outputs:</span></span>
<span class="code-line"><span class="c1">#reverse_string ('Able was I ere I saw Elba',) {}</span></span>
<span class="code-line"><span class="c1">#wrapper 0.0</span></span>
<span class="code-line"><span class="c1">#wrapper has been used: 1x</span></span>
<span class="code-line"><span class="c1">#ablE was I ere I saw elbA</span></span>
<span class="code-line"><span class="c1">#reverse_string ('A man, a plan, a canoe, pasta, heros, rajahs, a coloratura, maps, snipe, percale, macaroni, a gag, a banana bag, a tan, a tag, a banana bag again (or a camel), a crepe, pins, Spam, a rut, a Rolo, cash, a jar, sore hats, a peon, a canal: Panama!',) {}</span></span>
<span class="code-line"><span class="c1">#wrapper 0.0</span></span>
<span class="code-line"><span class="c1">#wrapper has been used: 2x</span></span>
<span class="code-line"><span class="c1">#!amanaP :lanac a ,noep a ,stah eros ,raj a ,hsac ,oloR a ,tur a ,mapS ,snip ,eperc a ,)lemac a ro( niaga gab ananab a ,gat a ,nat a ,gab ananab a ,gag a ,inoracam ,elacrep ,epins ,spam ,arutaroloc a ,shajar ,soreh ,atsap ,eonac a ,nalp a ,nam A</span></span>
</pre></div>
<p>装饰器意味着，你可以用正确的方法实现几乎所有的事情，而不必重写他们</p>
<div class="monokai"><pre><span class="code-line"><span></span><span class="nd">@counter</span></span>
<span class="code-line"><span class="nd">@benchmark</span></span>
<span class="code-line"><span class="nd">@logging</span></span>
<span class="code-line"><span class="k">def</span> <span class="nf">get_random_futurama_quote</span><span class="p">():</span></span>
<span class="code-line">    <span class="kn">import</span> <span class="nn">httplib</span></span>
<span class="code-line">    <span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="s2">"slashdot.org:80"</span><span class="p">)</span></span>
<span class="code-line">    <span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">"HEAD"</span><span class="p">,</span> <span class="s2">"/index.html"</span><span class="p">)</span></span>
<span class="code-line">    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span><span class="o">.</span><span class="n">getheaders</span><span class="p">():</span></span>
<span class="code-line">        <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"x-b"</span><span class="p">)</span> <span class="ow">or</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">"x-f"</span><span class="p">):</span></span>
<span class="code-line">            <span class="k">return</span> <span class="n">value</span></span>
<span class="code-line">    <span class="k">return</span> <span class="s2">"No, I'm ... doesn't!"</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="k">print</span> <span class="n">get_random_futurama_quote</span><span class="p">()</span></span>
<span class="code-line"><span class="k">print</span> <span class="n">get_random_futurama_quote</span><span class="p">()</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1">#outputs:</span></span>
<span class="code-line"><span class="c1">#get_random_futurama_quote () {}</span></span>
<span class="code-line"><span class="c1">#wrapper 0.02</span></span>
<span class="code-line"><span class="c1">#wrapper has been used: 1x</span></span>
<span class="code-line"><span class="c1">#The laws of science be a harsh mistress.</span></span>
<span class="code-line"><span class="c1">#get_random_futurama_quote () {}</span></span>
<span class="code-line"><span class="c1">#wrapper 0.01</span></span>
<span class="code-line"><span class="c1">#wrapper has been used: 2x</span></span>
<span class="code-line"><span class="c1">#Curse you, merciful Poseidon!</span></span>
</pre></div>
<p>Python本身提供了一些装饰器：property,staticmethod,等等，</p>
<p>Django使用装饰器去管理缓存和权限. Twisted to fake inlining asynchronous functions calls.用途广泛</p>
<p>EDIT: 鉴于这个回答的完美，人们希望我去回答metaclass,我这样做了</p>
    </section>

    <section id="copyright">
        <div class="copyright">
            版权声明：自由转载-非商用-非衍生-保持署名 | <a href="http://creativecommons.org/licenses/by-nc-nd/3.0/deed.zh" target="_blank" >Creative Commons BY-NC-ND 3.0</a>
        </div>

        <div class="donation">
            <center>
                <div style="width: 70%;">
                    <img src="/imgs/life/donation_w.png" style=""/>
                    <strong>
                        <div style="text-align:center;">
                            如果我的文章或项目对你有所帮助, 可以扫码进行小额捐赠<br>
                            如果有主机需求, 可点下方vultr进入注册, 带小尾巴:)<br>
                            如果要加广告位, 请邮件联系<br>
                        </ol>
                    </strong>
                </div>
            </center>

        </div>
    </section>


    <section id="neighbors">
        <div>
                        <a class="left" href="http://www.wklken.me/posts/2013/07/18/python-translate-yield.html">
                            上一篇:  [翻译]Python中yield的解释
                        </a>
                        <a class="right" href="http://www.wklken.me/posts/2013/07/20/python-stackoverflow-vote-top.html">
                            下一篇: [翻译整理]stackoverflow python 百问
                        </a>
        </div>
    </section>

    <section id="ad">
        <!-- <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> -->
        <!-- [> blog_ad_003 <] -->
        <!-- <ins class="adsbygoogle" -->
            <!-- style="display:block" -->
            <!-- data-ad-client="ca-pub-7635941258020589" -->
            <!-- data-ad-slot="7030416955" -->
            <!-- data-ad-format="auto"></ins> -->
        <!-- <script> -->
        <!-- (adsbygoogle = window.adsbygoogle || []).push({}); -->
        <!-- </script> -->

        <a href='http://www.vultr.com/?ref=6847203' target="_blank">
        <img src="/imgs/ads/vultr.png"> </img>
        </a>
    </section>



<section id="comments">
        <div class="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_identifier = "posts/2013/07/19/python-translate-decorator.html";
                (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://wklken.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            </div>
</section>



</article>
        </section><!--end #main-->

            <footer class="row">
                <div class="large-12 columns">
                    <p>
                            Copyright © 2015 wklken <br>
                            Hosted on <a href="http://www.vultr.com/?ref=6954153-3B"> vultr </a>. Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Social Icons by <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>.
                            <!-- Hosted on <a href="http://www.vultr.com/?ref=6847203"> vultr </a> Also <a href="https://www.digitalocean.com/?refcode=8ee73f2c47ce"> DigitalOcean </a>. Powered by <a href="http://alexis.notmyidea.org/pelican/">pelican</a>. Social Icons by <a href="http://fortawesome.github.io/Font-Awesome/">Font-Awesome</a>. -->
                    </p>
                </div>
            </footer>

            </div>
        </div>

        <section id="extras" class="body">
        </section><!-- /#extras -->



<script src="http://apps.bdimg.com/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="http://apps.bdimg.com/libs/jquery-scrollUp/2.1.0/jquery.scrollUp.min.js"></script>
<script src="http://apps.bdimg.com/libs/jqueryui/1.10.4/jquery-ui.min.js"></script>
<script>
    $(function(){
        $.scrollUp({
              scrollText: '', // Text for element, can contain HTML
            });
    });
</script>


<script type="text/javascript">
  /* var Swiftype = window.Swiftype || {}; */
  /* Swiftype.searchSearchFields = { */
    /* "page": ["title^10", "body"] */
  /* }; */

  /* (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){ */
  /* (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t); */
  /* e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e); */
  /* })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st'); */

  /* _st('install','v6K-_DamCeHvwX6z3o2F'); */
</script>



    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-42275748-1");
    pageTracker._trackPageview();
    } catch(err) {}</script>




<div id="share">
<script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"1","bdMiniList":["mshare","tsina","weixin","douban","meilishuo","mogujie","youdao","sdo","mail","twi","copy","print"],"bdPic":"","bdStyle":"0","bdSize":"16"},"slide":{"type":"slide","bdImg":"5","bdPos":"right","bdTop":"96.5"}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</div>



<script  src="http://www.wklken.me/theme/js/scroll-header.js" type="text/javascript"></script>




</body>
</html>